<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vigilancia FV Pro - Monitor de Riesgo</title>
  <style>
    :root {
      --bg: #05070a; --card: #0f172a; --accent: #38bdf8;
      --danger: #ff4d4d; --warning: #fbbf24; --safe: #10b981; --sun: #fde047;
      --border: #334155;
    }
    body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: #f1f5f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 15px; overflow-x: hidden; }
    
    .app-container { 
      background: var(--card); width: 100%; max-width: 440px; padding: 25px; border-radius: 28px; 
      border: 1px solid var(--border); box-shadow: 0 40px 100px rgba(0,0,0,0.8); position: relative;
    }

    /* BOT√ìN INFORMACI√ìN */
    .info-btn {
      position: absolute; top: 25px; right: 25px; width: 28px; height: 28px;
      background: var(--accent); color: #000; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; cursor: pointer; z-index: 150; font-family: serif;
    }

    #info-panel {
      position: absolute; inset: 0; background: var(--card); border-radius: 28px;
      z-index: 200; padding: 30px; display: none; overflow-y: auto; border: 1px solid var(--accent);
    }

    /* BUSCADOR Y GPS */
    .search-container { position: relative; margin-bottom: 20px; z-index: 110; margin-right: 40px; }
    .search-bar { display: flex; gap: 8px; align-items: center; }
    .search-input { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 12px; padding: 10px; color: white; outline: none; }
    .gps-btn { background: none; border: none; font-size: 1.4rem; cursor: pointer; transition: 0.3s; }

    .suggestions-list { position: absolute; top: 100%; left: 0; right: 0; background: #1e293b; border: 1px solid var(--border); border-radius: 0 0 12px 12px; max-height: 150px; overflow-y: auto; display: none; }
    .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.8rem; }

    /* CALENDARIO MENSUAL */
    .custom-calendar { background: rgba(255,255,255,0.02); padding: 12px; border-radius: 20px; border: 1px solid var(--border); margin-bottom: 15px; }
    .cal-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .cal-label { font-size: 0.75rem; font-weight: 800; color: var(--accent); text-transform: uppercase; }
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; text-align: center; }
    .day-name { font-size: 0.55rem; opacity: 0.5; }
    .day { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border-radius: 6px; background: rgba(255,255,255,0.03); font-size: 0.65rem; transition: 0.2s; }
    .day.active { background: var(--accent); color: #000; font-weight: bold; }
    .day.today { border: 1px solid var(--accent); }

    /* RADAR CON ESTE/OESTE */
    .radar-orbit {
      position: relative; width: 260px; height: 260px; margin: 0 auto 15px;
      border-radius: 50%; border: 2px solid rgba(56, 189, 248, 0.1);
      background: radial-gradient(circle, #1e293b 0%, #05070a 100%);
    }
    .cardinal { position: absolute; font-size: 10px; font-weight: bold; color: var(--accent); opacity: 0.5; z-index: 5; }
    .este { top: 50%; right: 10px; transform: translateY(-50%); }
    .oeste { top: 50%; left: 10px; transform: translateY(-50%); }
    .mask { position: absolute; bottom: 0; width: 100%; height: 50%; background: rgba(0,0,0,0.5); border-radius: 0 0 130px 130px; z-index: 4; pointer-events: none; }
    .astro { position: absolute; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; font-size: 30px; z-index: 10; transform: translate(-50%, -50%); transition: all 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); }

    /* SLIDER Y HORA */
    .slider-box { margin-top: 15px; position: relative; padding-top: 25px; }
    #time-bubble { position: absolute; top: 0; left: 50%; transform: translateX(-50%); background: var(--accent); color: #000; padding: 2px 12px; border-radius: 10px; font-weight: bold; font-size: 0.75rem; }
    input[type=range] { width: 100%; accent-color: var(--accent); cursor: pointer; }

    .risk-banner { padding: 12px; border-radius: 12px; text-align: center; font-weight: 900; margin-bottom: 15px; border: 1px solid var(--border); font-size: 0.85rem; text-transform: uppercase; }
    .metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .m-box { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; text-align: center; }
  </style>
</head>
<body onclick="resetToNow()">

<div class="app-container" onclick="event.stopPropagation()">
  <div class="info-btn" onclick="toggleInfo(true)">i</div>

  <div id="info-panel">
    <h2 style="color:var(--accent)">Manual de Riesgo</h2>
    <p>La iluminaci√≥n nocturna es el factor clave. Noches despejadas con luna llena permiten visibilidad natural a los ladrones (Riesgo Cr√≠tico).</p>
    <p><b>Nota Clima:</b> Los datos de nubes se obtienen en tiempo real para un periodo de 14 d√≠as.</p>
    <button onclick="toggleInfo(false)" style="width:100%; padding:12px; background:var(--accent); border:none; border-radius:8px; cursor:pointer; font-weight:bold;">VOLVER</button>
  </div>

  <div class="search-container">
    <div class="search-bar">
      <input type="text" id="city-input" class="search-input" placeholder="Buscar ubicaci√≥n..." oninput="handleSearch()">
      <button onclick="getGPS()" class="gps-btn" title="Ubicaci√≥n GPS">üß≠</button>
    </div>
    <div id="suggestions" class="suggestions-list"></div>
  </div>

  <div id="loc-display" style="font-size:0.7rem; color:var(--safe); font-weight:bold; margin-bottom:10px;">üìç Zona: Madrid</div>

  <div class="custom-calendar">
    <div class="cal-nav">
      <button onclick="changeMonth(-1)" style="background:none; border:none; color:white; cursor:pointer;">‚ùÆ</button>
      <span class="cal-label" id="cal-label"></span>
      <button onclick="changeMonth(1)" style="background:none; border:none; color:white; cursor:pointer;">‚ùØ</button>
    </div>
    <div class="cal-grid" id="cal-grid"></div>
  </div>

  <div id="risk-banner" class="risk-banner">CARGANDO...</div>

  <div class="radar-orbit">
    <span class="cardinal este">ESTE</span><span class="cardinal oeste">OESTE</span>
    <div class="mask"></div>
    <div id="sun-node" class="astro">‚òÄÔ∏è</div>
    <div id="moon-node" class="astro">üåë</div>
  </div>

  <div class="metrics">
    <div class="m-box"><small>ILUM. LUNA</small><br><b id="txt-illum">--</b></div>
    <div class="m-box"><small>NUBES</small><br><b id="txt-clouds">--</b></div>
  </div>

  <div class="slider-box">
    <div id="time-bubble">Hora: --:--</div>
    <input type="range" id="hour-slider" min="0" max="23" step="1" oninput="manualControl()">
  </div>
</div>

<script>
  let userLat = 40.41, userLon = -3.70;
  let weatherData = null;
  let currentView = new Date();
  let selectedDate = new Date();
  let isManual = false;

  function resetToNow() {
    isManual = false;
    selectedDate = new Date();
    currentView = new Date();
    renderCalendar();
    update();
  }

  function manualControl() { isManual = true; update(); }
  function toggleInfo(show) { document.getElementById('info-panel').style.display = show ? 'block' : 'none'; }

  function getGPS() {
    if (navigator.geolocation) {
      document.getElementById('loc-display').textContent = "üõ∞Ô∏è Buscando se√±al...";
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
          .then(res => res.json())
          .then(data => selectLocation(lat, lon, data.address.city || data.address.town || "Ubicaci√≥n GPS"))
          .catch(() => selectLocation(lat, lon, "Ubicaci√≥n GPS"));
      }, () => alert("Permiso de ubicaci√≥n denegado."));
    }
  }

  function getMoon(date) {
    const lp = 2551442.8; const ref = new Date("2000-01-06T18:14:00Z").getTime();
    const phase = (((date.getTime() - ref) / 1000) % lp) / lp;
    const illum = Math.abs(Math.sin(Math.PI * phase));
    const emojis = ["üåë","üåí","üåì","üåî","üåï","üåñ","üåó","üåò"];
    const idx = Math.floor(((phase < 0 ? phase + 1 : phase) * 8) + 0.5) % 8;
    return { emoji: emojis[idx], phase, illum: Math.round(illum * 100) };
  }

  async function handleSearch() {
    const q = document.getElementById('city-input').value;
    if(q.length < 3) return;
    const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=4&language=es&format=json`);
    const data = await res.json();
    if(data.results) {
      document.getElementById('suggestions').style.display = 'block';
      document.getElementById('suggestions').innerHTML = data.results.map(l => `<div class="suggestion-item" onclick="selectLocation(${l.latitude}, ${l.longitude}, '${l.name}')">${l.name} (${l.admin1 || ''})</div>`).join('');
    }
  }

  function selectLocation(lat, lon, name) {
    userLat = lat; userLon = lon;
    document.getElementById('loc-display').textContent = `üìç Zona: ${name}`;
    document.getElementById('suggestions').style.display = 'none';
    document.getElementById('city-input').value = "";
    initWeather();
  }

  function renderCalendar() {
    const grid = document.getElementById('cal-grid'); grid.innerHTML = '';
    const y = currentView.getFullYear(), m = currentView.getMonth();
    document.getElementById('cal-label').textContent = new Intl.DateTimeFormat('es-ES', { month: 'long', year: 'numeric' }).format(currentView);
    ['L','M','X','J','V','S','D'].forEach(d => grid.innerHTML += `<div class="day-name">${d}</div>`);
    const first = (new Date(y, m, 1).getDay() + 6) % 7;
    const total = new Date(y, m + 1, 0).getDate();
    const today = new Date();
    for (let i = 0; i < first; i++) grid.innerHTML += '<div></div>';
    for (let d = 1; d <= total; d++) {
      const dateObj = new Date(y, m, d);
      const moon = getMoon(dateObj);
      const isToday = dateObj.toDateString() === today.toDateString();
      const isSel = selectedDate.toDateString() === dateObj.toDateString();
      grid.innerHTML += `<div class="day ${isSel?'active':''} ${isToday?'today':''}" onclick="setDay(${d}, event)"><span>${d}</span><span style="font-size:0.5rem">${moon.emoji}</span></div>`;
    }
  }

  function setDay(d, e) {
    e.stopPropagation();
    selectedDate = new Date(currentView.getFullYear(), currentView.getMonth(), d);
    isManual = true;
    document.getElementById('hour-slider').value = 0;
    renderCalendar();
    update();
  }

  function changeMonth(n) { currentView.setMonth(currentView.getMonth() + n); renderCalendar(); }

  function getPos(hour, transit) {
    let diff = hour - transit; if (diff > 12) diff -= 24; if (diff < -12) diff += 24;
    const angle = 90 + (diff * 15); const rad = angle * Math.PI / 180;
    return { x: 130 + (138 * Math.cos(rad)), y: 130 - (138 * Math.sin(rad)), visible: angle > -5 && angle < 185, alt: Math.sin(rad) };
  }

  async function initWeather() {
    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${userLat}&longitude=${userLon}&hourly=cloud_cover&timezone=auto&forecast_days=14`);
    const data = await res.json(); weatherData = data.hourly;
    update();
  }

  function update() {
    let h = isManual ? parseInt(document.getElementById('hour-slider').value) : new Date().getHours();
    if (!isManual) document.getElementById('hour-slider').value = h;
    document.getElementById('time-bubble').textContent = (isManual ? "Simulaci√≥n: " : "Hora Real: ") + h.toString().padStart(2,'0') + ":00";

    const moon = getMoon(selectedDate);
    const mPos = getPos(h, (12 + (moon.phase * 24)) % 24);
    const sPos = getPos(h, 13.5);

    document.getElementById('moon-node').style.left = `${mPos.x}px`; document.getElementById('moon-node').style.top = `${mPos.y}px`;
    document.getElementById('moon-node').innerHTML = moon.emoji; document.getElementById('moon-node').style.opacity = mPos.visible ? "1" : "0.05";
    document.getElementById('sun-node').style.left = `${sPos.x}px`; document.getElementById('sun-node').style.top = `${sPos.y}px`;
    document.getElementById('sun-node').style.opacity = sPos.visible ? "1" : "0.05";

    let clouds = null;
    if (weatherData) {
      const start = new Date(); start.setHours(0,0,0,0);
      const target = new Date(selectedDate); target.setHours(h,0,0,0);
      const idx = Math.floor((target - start) / 3600000);
      clouds = (idx >= 0 && idx < weatherData.cloud_cover.length) ? weatherData.cloud_cover[idx] : null;
    }
    
    // VALIDACI√ìN DE DATOS DE NUBES
    const cloudDisplay = clouds !== null ? clouds + "%" : "‚ö†Ô∏è Sin datos";
    document.getElementById('txt-clouds').textContent = cloudDisplay;
    document.getElementById('txt-illum').textContent = moon.illum + "%";

    const banner = document.getElementById('risk-banner');
    if (sPos.visible) {
      banner.textContent = "üõ°Ô∏è D√çA: SIN RIESGO"; banner.style.background = "rgba(253, 224, 71, 0.1)"; banner.style.color = "var(--sun)";
    } else {
      // Ajuste de riesgo si no hay datos (asumimos un factor neutro de 0.8 de visibilidad)
      const cloudFactor = clouds !== null ? (1 - clouds/100) : 0.8;
      let risk = mPos.visible ? (moon.illum * mPos.alt * cloudFactor) : 0;
      
      if (risk > 45) { banner.textContent = "‚ö†Ô∏è RIESGO: CR√çTICO"; banner.style.background = "rgba(255, 77, 77, 0.2)"; banner.style.color = "var(--danger)"; }
      else { banner.textContent = "üõ°Ô∏è NOCHE SEGURA"; banner.style.background = "rgba(16, 185, 129, 0.2)"; banner.style.color = "var(--safe)"; }
    }
  }

  renderCalendar(); initWeather();
</script>
</body>
</html>
