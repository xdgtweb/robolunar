<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sentinel FV - Espa√±a Monitor Live</title>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #0f172a; --card: #1e293b; --text: #e2e8f0;
      --accent: #38bdf8; --danger: #ef4444; --warning: #f59e0b;
      --stealth: #8b5cf6; --safe: #10b981; --sun: #fbbf24; --moon: #94a3b8;
      --border: #334155; --hover: #334155;
    }
    body { margin: 0; font-family: 'Segoe UI', 'Roboto', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 10px; box-sizing: border-box; }

    /* LAYOUT */
    .dashboard { display: grid; grid-template-columns: 1fr; gap: 20px; width: 100%; max-width: 1000px; }
    @media (min-width: 768px) { .dashboard { grid-template-columns: 350px 1fr; } }
    
    .card { background: var(--card); border-radius: 16px; padding: 20px; border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.4); position: relative; }

    /* HEADER */
    .header-controls {
      display: flex; gap: 15px; flex-wrap: wrap; justify-content: space-between; align-items: center;
      background: #020617; padding: 15px; width: 100%; max-width: 1000px; border-radius: 16px; 
      border: 1px solid var(--border); margin-bottom: 20px; box-sizing: border-box; z-index: 50;
    }
    .loc-info { flex: 1; min-width: 200px; line-height: 1.2; }
    .loc-name { font-size: 1.3rem; font-weight: 800; color: var(--accent); }
    
    /* BUSCADOR */
    .search-wrapper { position: relative; width: 280px; max-width: 100%; }
    .search-input { 
      background: #0f172a; border: 1px solid var(--border); color: white; padding: 10px 15px; 
      border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 0.9rem;
    }
    .search-results {
      position: absolute; top: 100%; left: 0; width: 100%; background: #1e293b;
      border: 1px solid var(--border); border-top: none; border-radius: 0 0 10px 10px;
      max-height: 350px; overflow-y: auto; z-index: 100; display: none; box-shadow: 0 10px 30px black;
    }
    .result-item { padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .result-item:hover { background: var(--hover); }
    .fav-star { font-size: 1.2rem; cursor: pointer; color: #475569; padding: 0 8px; }
    .fav-star:hover, .fav-star.active { color: #fbbf24; text-shadow: 0 0 5px gold; }

    /* VISUALIZADOR DE CIELO Y NUBES */
    .sky-container {
      position: relative; width: 100%; height: 220px; 
      background: linear-gradient(to top, #0f172a 0%, #1e1b4b 100%);
      border-radius: 16px 16px 0 0; overflow: hidden; border-bottom: 2px solid var(--border);
    }
    /* Capa de nubes din√°micas */
    .cloud-layer { position: absolute; inset: 0; z-index: 3; pointer-events: none; overflow: hidden; }
    .cloud {
      position: absolute; background: rgba(255,255,255,0.1); border-radius: 50%;
      filter: blur(8px); opacity: 0; transition: opacity 1s;
    }
    /* Animaci√≥n flotante nubes */
    @keyframes floatCloud { from { transform: translateX(120%); } to { transform: translateX(-120%); } }

    .ground { position: absolute; bottom: 0; width: 100%; height: 30px; background: #1e293b; z-index: 10; display: flex; justify-content: space-between; padding: 0 15px; box-sizing: border-box; line-height: 30px; font-size: 0.75rem; color:#64748b; font-weight:bold; }
    .astro { position: absolute; width: 50px; height: 50px; transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center; font-size: 32px; z-index: 5; transition: top 0.1s, left 0.1s; }
    #astro-label { position: absolute; bottom: -18px; font-size: 10px; width: 120px; text-align: center; color: white; text-shadow: 0 2px 4px black; }

    /* CONTROLES TIEMPO */
    .live-controls { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px 0; background: var(--card); }
    .live-btn {
      background: #333; color: #aaa; border: 1px solid #444; padding: 5px 12px; border-radius: 20px;
      font-size: 0.75rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: 0.3s;
    }
    .live-btn.active { background: #ef4444; color: white; border-color: #ef4444; box-shadow: 0 0 10px rgba(239, 68, 68, 0.4); animation: pulse 2s infinite; }
    @keyframes pulse { 0% {box-shadow: 0 0 0 0 rgba(239,68,68, 0.4);} 70% {box-shadow: 0 0 0 6px rgba(239,68,68, 0);} 100% {box-shadow: 0 0 0 0 rgba(239,68,68, 0);} }
    
    .clock-xl { font-family: monospace; font-size: 2rem; font-weight: bold; color: var(--accent); letter-spacing: -1px; }

    .time-control { padding: 0 20px 20px; background: var(--card); border-radius: 0 0 16px 16px; }
    input[type=range] { width: 100%; accent-color: var(--accent); cursor: pointer; margin: 15px 0; }

    /* CALENDARIO & RIESGO */
    .cal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
    .cal-day { aspect-ratio: 1; display:flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(255,255,255,0.03); cursor: pointer; border-radius: 6px; position:relative; font-size: 0.9rem;}
    .cal-day:hover { background: rgba(255,255,255,0.1); }
    .cal-day.active { background: var(--accent); color: #000; font-weight: bold; }
    .cal-moon { font-size: 0.65rem; margin-top: 2px; }

    .risk-badge { padding: 15px; border-radius: 12px; font-size: 1rem; font-weight: 800; text-transform: uppercase; text-align: center; border: 1px solid transparent; background: rgba(0,0,0,0.3); margin-top: 20px; }
    .metrics-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 15px; }
    .metric-box { background: rgba(255,255,255,0.03); padding: 8px; border-radius: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
    .metric-val { font-size: 1.1rem; font-weight: bold; }
    .metric-lbl { font-size: 0.65rem; color: #94a3b8; text-transform: uppercase; }
  </style>
</head>
<body onload="initApp()">

<!-- CABECERA -->
<header class="header-controls">
  <div class="loc-info">
    <div id="city-display" class="loc-name">Cargando...</div>
    <div style="color:#64748b; font-size:0.85rem;">Lat: <span id="lat-display">--</span> | Lon: <span id="lon-display">--</span></div>
  </div>

  <div class="search-wrapper">
    <input type="text" id="search-input" class="search-input" placeholder="Buscar poblaci√≥n (empieza a escribir)..." autocomplete="off" oninput="handleInputSearch()" onfocus="handleInputSearch()">
    <div id="search-dropdown" class="search-results"></div>
  </div>
</header>

<div class="dashboard">
  
  <!-- COLUMNA IZQUIERDA -->
  <div class="left-col">
    <!-- CALENDARIO -->
    <div class="card" style="margin-bottom: 20px;">
      <div class="cal-header">
        <button style="background:none; border:none; color:white; cursor:pointer;" onclick="changeMonth(-1)">‚ùÆ</button>
        <span id="calendar-month-label" style="font-weight:bold; color:var(--accent)">--</span>
        <button style="background:none; border:none; color:white; cursor:pointer;" onclick="changeMonth(1)">‚ùØ</button>
      </div>
      <div class="calendar-grid" id="calendar-grid"></div>
    </div>

    <!-- PANEL DE RIESGO -->
    <div class="card">
      <div style="text-align:center; color:#64748b; font-size:0.75rem; text-transform:uppercase; font-weight:bold; letter-spacing:1px;">Datos Seguridad Perimetral</div>
      <div id="risk-banner" class="risk-badge">...</div>
      <p id="risk-detail" style="font-size:0.85rem; color:#94a3b8; text-align:center; margin-top:5px; line-height:1.4;">--</p>
      
      <div class="metrics-grid">
        <div class="metric-box"><div id="m-temp" class="metric-val">--¬∞</div><div class="metric-lbl">Temperatura</div></div>
        <div class="metric-box"><div id="m-cloud" class="metric-val">--%</div><div class="metric-lbl">Nubes</div></div>
        <div class="metric-box"><div id="m-rain" class="metric-val">--%</div><div class="metric-lbl">Lluvia</div></div>
        <div class="metric-box"><div id="m-moon" class="metric-val">--%</div><div class="metric-lbl">Ilum. Lunar</div></div>
      </div>
    </div>
  </div>

  <!-- COLUMNA DERECHA -->
  <div class="right-col">
    <div class="card" style="padding:0; overflow:hidden;">
      <!-- VISOR CIELO + NUBES -->
      <div class="sky-container" id="sky-view">
        <div id="clouds-container" class="cloud-layer"></div> <!-- Capa nubes -->
        
        <div class="astro" id="sun-el">‚òÄÔ∏è</div>
        <div class="astro" id="moon-el">üåë<div id="astro-label"></div></div>
        <div class="ground"><span>ESTE (Amanecer)</span><span>OESTE (Atardecer)</span></div>
      </div>

      <!-- BOTONERIA LIVE Y CONTROL -->
      <div class="live-controls">
        <div style="line-height:1;">
            <div id="clock-display" class="clock-xl">00:00:00</div>
            <div id="viewing-date" style="font-size:0.8rem; color:#64748b;">Hoy</div>
        </div>
        <button id="btn-live" class="live-btn active" onclick="activateLiveMode()">
            <span>‚óè</span> EN DIRECTO
        </button>
      </div>

      <div class="time-control">
        <input type="range" id="time-slider" min="0" max="143" value="0" oninput="userSliderInteraction()">
        <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#64748b; margin-top:-8px;">
          <span>00:00</span><span>06:00</span><span>12:00</span><span>18:00</span><span>23:59</span>
        </div>
      </div>
    </div>

    <!-- GR√ÅFICA INTERACTIVA -->
    <div class="card">
      <div id="chart-overlay" style="position:absolute; inset:0; background:rgba(15,23,42,0.8); display:none; justify-content:center; align-items:center; z-index:10; font-weight:bold; color:#94a3b8;">SIN DATOS</div>
      <div style="margin-bottom:10px; font-size:0.9rem; font-weight:bold; color:var(--accent);">Previsi√≥n 24h (D√≠a Seleccionado)</div>
      <div style="height: 200px; width: 100%;">
        <canvas id="weatherChart"></canvas>
      </div>
    </div>
  </div>

</div>

<script>
  // === ESTADO DE LA APLICACI√ìN ===
  const app = {
    isLive: true,
    city: "Madrid", lat: 40.41, lon: -3.70,
    currentDate: new Date(),  // Reloj interno Live
    selectedDate: new Date(), // D√≠a seleccionado en calendario
    sliderVal: 0,             // 0-143 (10 min pasos)
    weatherData: null,
    favorites: JSON.parse(localStorage.getItem('favs_esp_live') || "[]"),
    timer: null
  };

  const D = {
    // Refs DOM
    lblCity: document.getElementById('city-display'),
    lblLat: document.getElementById('lat-display'),
    lblLon: document.getElementById('lon-display'),
    searchIn: document.getElementById('search-input'),
    searchBox: document.getElementById('search-dropdown'),
    clock: document.getElementById('clock-display'),
    dateLbl: document.getElementById('viewing-date'),
    btnLive: document.getElementById('btn-live'),
    slider: document.getElementById('time-slider'),
    clouds: document.getElementById('clouds-container'),
    cal: document.getElementById('calendar-grid'),
    month: document.getElementById('calendar-month-label'),
    risk: document.getElementById('risk-banner'),
    riskTxt: document.getElementById('risk-detail'),
    val: { t:document.getElementById('m-temp'), c:document.getElementById('m-cloud'), r:document.getElementById('m-rain'), m:document.getElementById('m-moon') },
    astro: { s:document.getElementById('sun-el'), m:document.getElementById('moon-el'), mLbl:document.getElementById('astro-label') }
  };

  function initApp() {
    loadLastLocation();
    renderCalendar();
    
    // Iniciar Reloj Global (Corre cada segundo)
    setInterval(gameLoop, 1000);
    
    document.addEventListener('click', (e) => {
      if(!D.searchIn.contains(e.target)) D.searchBox.style.display = 'none';
    });
  }

  // === MOTOR PRINCIPAL (GAME LOOP) ===
  function gameLoop() {
    if (app.isLive) {
      app.currentDate = new Date();
      app.selectedDate = new Date(); // En live, seleccionamos hoy
      updateTimeDisplay(true); // Mostrar segundos
      updateEnvironment();
      
      // Sincronizar slider visualmente sin disparar evento 'input'
      const mins = app.currentDate.getHours()*60 + app.currentDate.getMinutes();
      D.slider.value = Math.floor(mins / 10);
    }
  }

  // Interacci√≥n manual (Usuario toca slider)
  function userSliderInteraction() {
    disableLiveMode();
    app.sliderVal = parseInt(D.slider.value);
    updateEnvironment();
  }
  
  // Activar Live
  function activateLiveMode() {
    app.isLive = true;
    D.btnLive.classList.add('active');
    app.selectedDate = new Date();
    renderCalendar(); // Reset selecci√≥n visual
    // Si la gr√°fica era de otro d√≠a, se actualizar√° en el loop al cambiar selectedDate
    gameLoop(); 
  }

  // Desactivar Live
  function disableLiveMode() {
    app.isLive = false;
    D.btnLive.classList.remove('active');
    updateTimeDisplay(false); // Quitar segundos
  }

  function updateTimeDisplay(showSeconds) {
    let date = app.selectedDate;
    if (!app.isLive) {
        // En manual calculamos fecha en base a slider
        date = new Date(app.selectedDate);
        date.setHours(0,0,0,0);
        date.setMinutes(parseInt(D.slider.value) * 10);
    }
    
    const h = date.getHours().toString().padStart(2,'0');
    const m = date.getMinutes().toString().padStart(2,'0');
    const s = date.getSeconds().toString().padStart(2,'0');
    
    D.clock.innerText = showSeconds ? `${h}:${m}:${s}` : `${h}:${m}`;
    D.dateLbl.innerText = app.selectedDate.toLocaleDateString('es-ES', {weekday:'long', day:'numeric', month:'long'});
  }

  // === VISUALES Y CLIMA ===
  function updateEnvironment() {
    if (!app.weatherData) return;
    
    // 1. Determinar Fecha/Hora exacta para sacar datos
    let targetDate = new Date(app.selectedDate);
    if (!app.isLive) {
        targetDate.setHours(0,0,0,0);
        targetDate.setMinutes(parseInt(D.slider.value) * 10);
    } else {
        targetDate = new Date(); // Ahora exacto
    }

    // 2. Extraer datos (interpolacion o match horario)
    const { temp, cloud, rain } = getDataForTime(targetDate);
    
    // 3. Render Widgets
    D.val.t.innerText = (temp ?? '--') + '¬∞';
    D.val.c.innerText = cloud + '%';
    D.val.r.innerText = rain + '%';
    
    // 4. Calcular Astros
    const mins = targetDate.getHours()*60 + targetDate.getMinutes();
    const moon = getMoon(targetDate);
    D.val.m.innerText = Math.round(moon.illum * 100) + '%';
    D.astro.m.innerHTML = moon.emoji;
    D.astro.mLbl.innerText = Math.round(moon.illum*100)+"%";
    
    // Posicionar Sol/Luna
    setOrbit(D.astro.s, mins, 360, 1260); // 06:00 - 21:00 Sol
    let moonT = mins - (moon.phase * 1440); if(moonT<0) moonT+=1440;
    setOrbit(D.astro.m, moonT, 200, 1240);
    
    // 5. NUBES VISUALES EN CSS
    renderCloudsCSS(cloud);

    // 6. RIESGO
    analyzeRisk(D.astro.s.style.opacity==='1', D.astro.m.style.opacity==='1', moon.illum, cloud, temp, rain);
    
    // 7. Actualizar Gr√°fica (solo si cambiamos de dia)
    updateChart(targetDate);
  }

  function renderCloudsCSS(pct) {
    // Generar nubecitas seg√∫n el % de nubes.
    // L√≥gica sencilla: Limpiar y crear nuevas si cambia dr√°sticamente
    // Para no machacar el DOM a 60fps, lo hacemos si cambia de decena
    const density = Math.floor(pct / 10); 
    const currentNodes = D.clouds.childElementCount;
    
    // Solo regenerar si hay gran cambio (para evitar parpadeo en Directo constante) o si est√° vac√≠o
    if (Math.abs(currentNodes - density) > 1 || (pct > 0 && currentNodes === 0)) {
       D.clouds.innerHTML = "";
       // Crear nubes
       // Nube SVG shape inline
       const svgCloud = `<svg viewBox="0 0 24 24" fill="currentColor" width="100%" height="100%"><path d="M18.5,12c0-1.7-1.4-3.1-3.1-3.1c-0.1,0-0.3,0-0.4,0C14.4,6.9,12.3,5.5,10,5.5c-3,0-5.5,2.5-5.5,5.5c0,0.1,0,0.2,0,0.2C2.1,11.8,0.5,13.8,0.5,16c0,2.5,2,4.5,4.5,4.5h13.5c3,0,5.5-2.5,5.5-5.5C24,13,21.5,12,18.5,12z"/></svg>`;
       
       for (let i=0; i<density*2; i++) { // Multiplicador para visual
           let el = document.createElement('div');
           el.innerHTML = svgCloud;
           el.style.position = "absolute";
           el.style.color = "rgba(255,255,255," + (0.2 + (pct/200)) + ")"; // Mas opaco si mas nube
           el.style.width = (40 + Math.random()*80) + "px";
           el.style.height = el.style.width;
           el.style.top = (Math.random() * 80) + "%"; // Altura random
           
           // Animacion
           let duration = 20 + Math.random()*40; // 20s a 60s
           el.style.animation = `floatCloud ${duration}s linear infinite`;
           el.style.animationDelay = `-${Math.random()*60}s`; // Iniciar en medio pantalla
           
           D.clouds.appendChild(el);
       }
    }
  }

  function setOrbit(el, t, rise, set) {
    const W = D.clouds.offsetWidth; const H = 220;
    if (t >= rise && t <= set) {
        const p = (t-rise)/(set-rise);
        el.style.left = (p*W) + 'px';
        el.style.top = (H - 40 - Math.sin(p*Math.PI)*(H-80)) + 'px';
        el.style.opacity = 1;
    } else {
        el.style.top = (H+50)+'px'; el.style.opacity=0;
    }
  }

  function getDataForTime(date) {
    if(!app.weatherData) return {temp:null, cloud:0, rain:0};
    // Match API (ISO string slice '2024-01-01T15')
    const key = date.toISOString().slice(0,13); 
    const idx = app.weatherData.time.findIndex(t => t.startsWith(key));
    if (idx !== -1) {
        return {
            temp: app.weatherData.temperature_2m[idx],
            cloud: app.weatherData.cloud_cover[idx],
            rain: app.weatherData.precipitation_probability[idx]
        };
    }
    return {temp:null, cloud:0, rain:0}; // Fuera de rango API
  }

  // === RIESGO (Seguridad) ===
  function analyzeRisk(sun, moon, ill, cld, tmp, rain) {
    let risk = 0; let msg = ""; let css = "";
    
    const disuade = (tmp!=null && tmp < 5) || (rain > 50); // Lluvia/Frio protege
    
    if (sun) {
        D.risk.innerText = "ZONA SEGURA (DIA)"; D.risk.style.background="#fcd34d33"; D.risk.style.color="#fbbf24";
        D.riskTxt.innerText = "Actividad diurna normal.";
    } else {
        // Noche
        const moonLight = moon ? (ill * (1 - cld/100)) : 0;
        if (moonLight > 0.6) {
            D.risk.innerText = disuade ? "RIESGO MEDIO (DISUASI√ìN CLIM√ÅTICA)" : "ALERTA: INTRUSI√ìN SIGILOSA";
            D.risk.style.background = "#8b5cf633"; D.risk.style.color = "#a78bfa";
            D.riskTxt.innerText = "Luz lunar alta. Posibilidad de operar sin linterna artificial.";
        } else {
            D.risk.innerText = disuade ? "NOCHE SEGURA" : "DETECCI√ìN FAVORABLE";
            D.risk.style.background = disuade ? "#10b98133" : "#0ea5e933";
            D.risk.style.color = disuade ? "#34d399" : "#38bdf8";
            D.riskTxt.innerText = "Oscuridad profunda. Obliga uso linterna visible por c√°maras.";
        }
    }
  }

  // === BUSCADOR (Sensible) ===
  let searchTimer;
  function handleInputSearch() {
    D.searchBox.style.display = 'block';
    const q = D.searchIn.value.trim();
    
    if(q.length === 0) { renderFavs(); return; }
    
    // Busca desde 1 letra (como pedido)
    clearTimeout(searchTimer);
    D.searchBox.innerHTML = '<div style="padding:10px;text-align:center;color:#666;">Buscando...</div>';
    
    searchTimer = setTimeout(async () => {
        try {
            // Count 20 para captar muchas
            const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=20&language=es&format=json`);
            const dat = await res.json();
            
            D.searchBox.innerHTML = "";
            if(!dat.results) { D.searchBox.innerHTML='<div style="padding:10px;">Sin resultados.</div>'; return; }
            
            // Filtro Espa√±a manual extra (country_code ES)
            const matches = dat.results.filter(x => x.country_code === 'ES');
            if(!matches.length) { D.searchBox.innerHTML='<div style="padding:10px;">Solo disponible en Espa√±a.</div>'; return; }
            
            matches.forEach(city => {
                let div = document.createElement('div');
                div.className = "result-item";
                const isFav = app.favorites.some(f=>f.lat===city.latitude);
                div.innerHTML = `
                  <div onclick="selectCity('${city.name}',${city.latitude},${city.longitude})">
                    <b>${city.name}</b> <small style="color:#666">${city.admin1||''}</small>
                  </div>
                  <div class="fav-star ${isFav?'active':''}" onclick="toggleFav('${city.name}',${city.latitude},${city.longitude})">‚òÖ</div>
                `;
                D.searchBox.appendChild(div);
            });
        } catch(e) {}
    }, 250);
  }

  function selectCity(n,la,lo) {
    app.city=n; app.lat=la; app.lon=lo;
    localStorage.setItem('sentinel_loc', JSON.stringify({n,la,lo}));
    D.searchBox.style.display='none'; D.searchIn.value='';
    loadData(); // Recarga clima
    activateLiveMode(); // Vuelve al directo de esa ciudad
  }

  function toggleFav(n,la,lo) {
    const idx = app.favorites.findIndex(f => f.lat===la);
    if(idx>-1) app.favorites.splice(idx,1); else app.favorites.push({n,lat:la,lon:lo});
    localStorage.setItem('favs_esp_live', JSON.stringify(app.favorites));
    handleInputSearch(); // Refresh list
  }
  function renderFavs() {
    D.searchBox.innerHTML = '<div style="padding:5px 10px;font-size:0.7rem;font-weight:bold;color:#444">MIS FAVORITOS</div>';
    if(!app.favorites.length) D.searchBox.innerHTML += '<div style="padding:10px;font-size:0.8rem">No hay favoritos. Pulsa la ‚òÖ</div>';
    app.favorites.forEach(f => {
        let div = document.createElement('div'); div.className = "result-item";
        div.innerHTML = `<span onclick="selectCity('${f.n}',${f.lat},${f.lon})">${f.n}</span> <span class="fav-star active" onclick="toggleFav('${f.n}',${f.lat},${f.lon})">‚òÖ</span>`;
        D.searchBox.appendChild(div);
    });
  }

  // === DATA LOADING ===
  function loadLastLocation() {
    let sv = localStorage.getItem('sentinel_loc');
    if(sv) { let o=JSON.parse(sv); app.city=o.n; app.lat=o.la; app.lon=o.lo; }
    loadData();
  }
  async function loadData() {
    D.lblCity.innerText = app.city;
    D.lblLat.innerText = app.lat.toFixed(2); D.lblLon.innerText = app.lon.toFixed(2);
    // API 14 dias
    try {
        const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${app.lat}&longitude=${app.lon}&hourly=temperature_2m,precipitation_probability,cloud_cover&forecast_days=14&timezone=auto`);
        const d = await r.json();
        app.weatherData = d.hourly;
    } catch(e) {}
  }

  // === GRAFICA MAGN√âTICA ===
  let myChart;
  function updateChart(date) {
    // Si la grafica ya es del dia correcto, no tocar (ahorra recursos)
    // Extraemos YYYY-MM-DD
    const isoDate = date.toISOString().split('T')[0];
    
    // Preparar dataset para este d√≠a
    if(!app.weatherData) return;
    const startIndex = app.weatherData.time.findIndex(t => t.startsWith(isoDate));
    
    const overlay = document.getElementById('chart-overlay');
    
    if (startIndex === -1 || (startIndex+24 > app.weatherData.time.length)) {
        overlay.style.display = 'flex'; // No data
        return;
    }
    overlay.style.display = 'none';

    // Construir datos
    let lbls=[], tData=[], cData=[];
    for(let i=0; i<24; i++) {
        lbls.push(i+":00");
        tData.push(app.weatherData.temperature_2m[startIndex+i]);
        cData.push(app.weatherData.cloud_cover[startIndex+i]);
    }

    const ctx = document.getElementById('weatherChart').getContext('2d');
    if (myChart) {
        // Actualizar datos solo si han cambiado (ej, cambiamos de ciudad o de d√≠a)
        // Simplificacion: actualizar siempre que se llame la funcion con dia nuevo
        if(myChart.data.datasets[0].data[0] !== tData[0]) {
            myChart.data.datasets[0].data = tData;
            myChart.data.datasets[1].data = cData;
            myChart.update();
        }
    } else {
        // Configuraci√≥n para que el hover sea facil ("Magn√©tica") -> mode: 'index', intersect: false
        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: lbls,
                datasets: [
                    { label: 'Temp', data: tData, borderColor: '#38bdf8', tension:0.4, yAxisID:'y' },
                    { label: 'Nubes', data: cData, borderColor: '#94a3b8', borderDash:[5,5], tension:0.4, pointRadius:0, yAxisID:'y1' }
                ]
            },
            options: {
                responsive:true, maintainAspectRatio:false,
                interaction: { mode: 'index', intersect: false }, // LA CLAVE: No hay que apuntar al punto
                plugins: { legend: {labels:{color:'white'}}, tooltip:{mode:'index', intersect:false} },
                scales: {
                    x: {ticks:{color:'#64748b'}},
                    y: {display:true, position:'left', ticks:{color:'#38bdf8'}, grid:{color:'#33415555'}},
                    y1: {display:true, position:'right', min:0, max:100, grid:{display:false}}
                }
            }
        });
    }
  }

  // === AUX: Calendario y Luna ===
  function changeMonth(d) {
    let cm = app.currentDate.getMonth();
    app.currentDate.setMonth(cm+d);
    renderCalendar();
  }
  function renderCalendar() {
    D.cal.innerHTML = "";
    const y = app.currentDate.getFullYear(); const m = app.currentDate.getMonth();
    D.month.innerText = new Intl.DateTimeFormat('es-ES',{month:'long',year:'numeric'}).format(app.currentDate).toUpperCase();
    
    // Dias semana
    ['L','M','X','J','V','S','D'].forEach(x=>D.cal.innerHTML+=`<div style="text-align:center;font-size:0.7rem;color:#555">${x}</div>`);
    
    let fst = (new Date(y,m,1).getDay()+6)%7;
    let days = new Date(y,m+1,0).getDate();
    
    for(let i=0; i<fst; i++) D.cal.innerHTML+="<div></div>";
    for(let i=1; i<=days; i++) {
        let div = document.createElement('div');
        let dayDate = new Date(y,m,i);
        div.className = "cal-day";
        // Si coincide con seleccionado visualmente
        if(dayDate.toDateString() === app.selectedDate.toDateString()) div.classList.add('active');
        if(dayDate.toDateString() === new Date().toDateString()) div.style.border="1px solid #fbbf24"; // Hoy borde amarillo
        
        let mn = getMoon(dayDate);
        div.innerHTML = `${i}<div class="cal-moon">${mn.emoji}</div>`;
        
        div.onclick = () => {
            disableLiveMode();
            app.selectedDate = dayDate;
            app.sliderVal = 72; D.slider.value=72; // Reset slider a medio dia
            renderCalendar();
            updateEnvironment();
        };
        D.cal.appendChild(div);
    }
  }
  
  function getMoon(date) {
    const lp = 2551442.8; const ref = new Date("2000-01-06T18:14:00Z").getTime();
    const ph = (((date.getTime() - ref) / 1000) % lp) / lp;
    const p = ph < 0 ? ph+1 : ph;
    const i = Math.floor(p*8 + 0.5)%8;
    return { 
        emoji: ["üåë","üåí","üåì","üåî","üåï","üåñ","üåó","üåò"][i],
        illum: 0.5*(1-Math.cos(2*Math.PI*p)),
        phase: p
    };
  }

</script>
</body>
</html>
